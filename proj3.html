<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<script src="pro3_gui.js"></script>
	<script src="person.js"></script>	
	<script src="caravan.js"></script>
	<script src=" https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link rel="stylesheet" href="interact.css">
</head>
<body>
	<script>
		$('document').ready(function() {
			//Basic cost constants for stores
			const OXEN = 20;
			const CLOTHING = 10;
			const PART = 10;
			const AMMO = .40;
			const FOOD = .2;
			var travID;  //This cannot be cleaned up.  Variable scoping is critical to event handling
			var weather = "clear";  //Default weather
			var caravan = new Caravan(1, "Banker");  //Similarly, this needs to be kept here for scoping.
			//Everything in this area is for testing purposes and should be cleaned, eventually.
			// Draw the animated canvas
			drawCanvas(caravan.location);
			loadData(weather);  
			caravan.makeMember("Potato");
			console.log(caravan.members);
			console.log(caravan.day);
			caravan.goFishing();
			console.log(caravan.food);
			caravan.rest(1);
			console.log(caravan.food);
			caravan.rest(2);
			console.log(caravan.food);
			console.log(caravan.members[0].isAlive());
			console.log("Living check", caravan.checkForDead());
			caravan.pace = 1;
			//Function to make oxen walk and stuff happen while traveling.
			function travel(){
				//Repeat an arbitrary number of times...
				travID = setInterval ( () => {
					loadInteract(getWeather());  
					if (caravan.checkForDead() == -1) {
						console.log("Here Lies Potato");
						clearInterval(travID);
						drawGrave("Potato");
						return -1;
					}
					caravan.getEvent();  //critical
					console.log("Rolling along", caravan.distance);
					console.log("Living check", caravan.checkForDead());
					console.log("Next landmark:", caravan.nextLandmark);
					loadInteract(getWeather());  //testing
					loadData(getWeather());  //critical
					if(caravan.nextLandmark == "flag1"){ //testing
						caravan.goToGreenRiver();
					}
					else if(caravan.nextLandmark == "flag2"){ //also testing
						caravan.goToTheDalles();
					}
					//this block is critical
					dist = caravan.target_distance - caravan.distance;
					console.log("Distance to Next Landmark: ", dist);
					animateWagon(caravan.pace);
					if (dist <= 60) {
						animateLandmark(dist, caravan.pace, caravan.nextLandmark);
					}
				}, 2000); //every 2 seconds.
			}
			//Convert pace into words.
			function getPace(){
				if(caravan.pace == 1){
					return "steady";
				} else if(caravan.pace == 1.5){
					return "strenuous";
				} else {
					return "grueling";
				}
			}
			//Convert rations into words.
			function getRations(){
				if(caravan.rations == 3){
					return "filling";
				} else if(caravan.rations == 2){
					return "meager";
				} else{
					return "bare bones";
				}
			}
			//Function to handle buying things at forts.  Pass it the item number and quantity and
			//it will do the rest
			function buyThings(item, number){
				var fort_cost = 1;
				var item_cost = 0;
				if(caravan.fort){
					fort_cost += (caravan.fort - 1) / 4; 
				}
				if(item * number * fort_cost > caravan.money){
					return false;
				}
				if(item == 1){
					caravan.oxen += number;
					item_cost = OXEN;
				} else if(item == 2) {
					caravan.clothing += number;
					item_cost = CLOTHING;
				} else if(item == 2) {
					caravan.ammo += number * 20;
					item_cost = AMMO;
				} else if(item == 2) {
					caravan.wheel += number;
					item_cost = PART;
				} else if(item == 2) {
					caravan.tongue += number;
					item_cost = PART;
				} else if(item == 2) {
					caravan.axle += number;
					item_cost = PART;
				} else if(item == 2) {
					caravan.food += number;
					item_cost = FOOD;
				}
				caravan.money -= item_cost * number * fort_cost;
				return true;
			}
			//Translate the date from number to a date.
			function getDate(){
				if(caravan.day > 273) {
					//game over
				}
				if(caravan.day <= 30){
					return "April " + caravan.day + ", 1848"
				} else if(caravan.day <= 61){
					return "May " + (caravan.day - 30) + ", 1848"
				} else if(caravan.day <= 91){
					return "June " + (caravan.day - 61) + ", 1848"
				} else if(caravan.day <= 122){
					return "July " + (caravan.day - 91) + ", 1848"
				} else if(caravan.day <= 152){
					return "August " + (caravan.day - 122) + ", 1848"
				} else if(caravan.day <= 183){
					return "September " + (caravan.day - 152) + ", 1848"
				} else if(caravan.day <= 213){
					return "October " + (caravan.day - 183) + ", 1848"
				} else if(caravan.day <= 244){
					return "November " + (caravan.day - 213) + ", 1848"
				} else if(caravan.day <= 274){
					return "December " + (caravan.day - 244) + ", 1848"
				}
			}
			//Figure out what today's weather is.
			function getWeather(){
				value = Math.floor(Math.random() * 100);
				if(this.day < 60 || this.day > 210){
					value -= 10;
				} 
				else if(this.day > 120 && this.day < 180){
					value += 10;
				}
				if(value < 2) {
					return weather = "cold";
				}
				else if(value < 32){
					return weather = "cool";
				}
				else if(value < 46){
					return weather = "rainy";
				}
				else if(value < 49){
					return weather = "very rainy";
				}
				else if(value < 71){
					return weather = "warm";
				}
				else if(value < 97){
					return weather = "hot";
				}
				else{
					return weather = "very hot";
				}
			}
			//Load data into the interact page.
			function loadInteract(weather){
				$('.frame-interact').find('.header').html(
					"<br>" + getDate() + "<br>"
				);
				$('.frame-interact').find('.status').html(
					"&nbsp;&nbsp;Weather: " + weather + "<br>&nbsp;&nbsp;Health: " + caravan.partyHealth() + "<br>&nbsp;&nbsp;Pace: " + getPace() + "<br>&nbsp;&nbsp;Rations: " + getRations() + "<br>"
				);
			}
			//Load data into the ui of the travel page.
			function loadData(weather){
				drawEnvironment(weather, caravan.location);
				$('.frame-travel').find('.data').html(
					"" + getDate() + "<br>" + weather + "<br>" + caravan.partyHealth() + "<br>" + caravan.food + "<br>" + (caravan.target_distance - caravan.distance) + "<br>" + caravan.distance
				);
			}
			//This function is going to get massive, I think.  
			//Handles key press events.
			$(document).keydown(function(){
				key_code = event.keyCode;
				console.log(key_code)

				//Find the visible frame.
				var activeFrame = $('.frame:visible').attr('class');
				//Handle based on active frame.
				if(activeFrame == "frame frame-travel") {
					//If key is enter, stop the game.
					if(key_code==13) {
						clearInterval(travID);
						$('.frame-travel').hide();
						$('.frame-interact').show();
					}
				}
				else if(activeFrame == "frame frame-interact") {
					if(key_code==32) {
						clearInterval(travID); //This prevents warp speed.
						$('.frame-travel').show();
						$('.frame-interact').hide();
						travel();
					//If the key is 1-8, do the thing.
					} else if (key_code >= 49 && key_code <= 55){

					}//If the key is 9, this needs to be validated.
					else if(key_code == 57){

					} //If the user has already provided an input, process it...
					else if(key_code == 13){

					}
				}
				else if(activeFrame == "frame frame-hall"){
					//If the game is over, let them enter letters.
					if(0){}
					else if(key_code==32){
						$('.frame-hall').hide();
						$('.frame-intro').show();
					}
				}
				else if(activeFrame == "frame frame-intro"){
					if(key_code >= 49 && key_code <= 51){
						$('.frame-intro').find('#response').html(event.key);
					}
					else if(key_code == 13){
						var cur = $('.frame-intro').find('#response').html();
						if(cur == 1){
							$('.frame-travel').show();
							$('.frame-intro').hide();
							travel();
						} else if (cur == 2){
							$('.frame-intro').find('#response').html(" ");
							$.get( "getTen.php", function(data){
								pairs = data.split("\n");
								for(var i = 0; i < 10; i++){
									player = pairs[i].split(',');
									$('.frame-hall').find('#players').append(player[0] + "<br>");
									$('.frame-hall').find('#scores').append(player[1] + "<br>");
								}
								console.log(pairs);
								$('.frame-hall').show();
								$('.frame-intro').hide();
							});
						}
					}
				}	

			});
		});
	</script>
	<div class="border"></div>
	<div class="frame frame-travel" style="display: none;">
		<img id="wagon" height="0px" width="0px" src="./oregon_trail_sprites/ot_misc.gif">
		<img id="location" height="0px" width="0px" src="./oregon_trail_sprites/ot_misc.gif">
		<canvas id="myCanvas" width="600" height="190" style="border:0px solid black;"></canvas>
		<p id="info" class="size_up" style="font-family:georgia">
				Press enter to size up the situation.
		<div id="data" class="data-frame"><p class="labels" style="font-family:georgia">
				Date :<br>
				Weather :<br>
				Health :<br>
				Food :<br>
				Next landmark :<br>
				Miles traveled :<br>
		</p>
		<p class="data" style="font-family:georgia">
			
		</p></div>
	</div>
	<div class="frame frame-interact" style="display: none;">
		<p class="header" style="font-family:georgia">
		Independence<br>
		Date<br>
		</p>
		<p class="status" style="font-family:georgia">
			Weather: getweather<br>
			Health: gethealth<br>
			Pace: getpace<br>
			Rations: getrations<br>
		</p>
		<p class="options" style="font-family:georgia">
			&nbsp;&nbsp;You may: <br><br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Continue on trail<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. Check supplies<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3. Look at map<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4. Change pace<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5. Change food rations<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6. Stop to rest<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7. Attempt to trade<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8. Go fishing<br><br><br>

			&nbsp;&nbsp;What is your choice?
		</p>
		<p class="response" style="font-family:georgia">
		</p>
	</div>
	<div class="frame frame-image" style="display: none;">
	</div>
	<div class="frame frame-text" style="display: none;">
	</div>
	<div class="frame frame-hall" style="display:none;">
		<p id="columns" style="font-family:georgia"><u>Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scores</u>
		</p>
		<p id="players" style="font-family:georgia">
		</p>
		<p id="scores" style="font-family:georgia">
		</p>
	</div>
	<div class="frame frame-intro">
		<p class="title" style="font-family:georgia">
			The Oregon Trail
		</h1>
		<p id="options" style="font-family:georgia">
			&nbsp;&nbsp;You may:<br><br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Travel the trail<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. See the top ten<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3. New player advice<br>

			<br><br>&nbsp;&nbsp;What is your choice?
		</p>
		<p id="response" style="font-family:georgia"></p>
	</div>
</body>
</html>